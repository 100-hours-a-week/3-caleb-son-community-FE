name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_DIR: ~/community-project
  NGINX_DIR: ~/nginx-proxy

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure (docker-compose.yml & nginx)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH 키 생성 및 권한 설정
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # 키 파일 확인 (디버깅)
          echo "Checking key file..."
          echo "File size: $(wc -c < ~/.ssh/deploy_key) bytes"
          echo "First line: $(head -1 ~/.ssh/deploy_key)"
          echo "Last line: $(tail -1 ~/.ssh/deploy_key)"
          
          # SSH 키 형식 검증
          echo "Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/deploy_key 2>&1; then
            echo "Error: Invalid SSH private key format"
            echo "Key file content (first 5 lines):"
            head -5 ~/.ssh/deploy_key
            exit 1
          fi
          
          # Known hosts 설정
          echo "Setting up known hosts..."
          ssh-keyscan -H ${{ secrets.PUBLIC_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ secrets.PRIVATE_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Public EC2 연결 테스트
          echo "Testing connection to Public EC2..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} "echo 'Connection successful'" || {
            echo "Error: Failed to connect to Public EC2"
            echo "Trying verbose mode for debugging..."
            ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              ubuntu@${{ secrets.PUBLIC_EC2_IP }} "echo 'test'" 2>&1 | tail -20
            exit 1
          }
      
      # SSH 키를 Public EC2에 복사 (Private EC2 접근용)
      - name: Copy SSH key to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ~/.ssh/deploy_key \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/.ssh/deploy_key
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} "chmod 600 ~/.ssh/deploy_key && mkdir -p ~/.ssh && chmod 700 ~/.ssh"
      
      # docker-compose.yml을 Public EC2로 먼저 전송 후 Private EC2로 전송
      - name: Transfer docker-compose.yml to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/
      
      - name: Transfer docker-compose.yml to Private EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }}:${{ env.PROJECT_DIR }}/
          rm docker-compose.yml
          ENDSSH
      
      # nginx 설정을 Public EC2로 전송
      - name: Create nginx archive
        run: tar -czf nginx.tar.gz nginx/
      
      - name: Transfer nginx to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            nginx.tar.gz \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }}:${{ env.NGINX_DIR }}/
      
      - name: Extract and deploy nginx
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          cd ${{ env.NGINX_DIR }}
          tar -xzf nginx.tar.gz
          rm nginx.tar.gz
          
          # Private EC2 IP를 nginx.conf에 설정
          sed -i "s/server [0-9.]*:8080/server ${{ secrets.PRIVATE_EC2_IP }}:8080/g" nginx/nginx.conf
          sed -i "s/server [0-9.]*:3003/server ${{ secrets.PRIVATE_EC2_IP }}:3003/g" nginx/nginx.conf
          
          # Nginx 재시작
          cd nginx
          docker-compose down || true
          docker-compose up -d
          ENDSSH
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f nginx.tar.gz

  deploy-frontend:
    name: Deploy Frontend to Private EC2
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
      - name: Checkout Frontend Code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH 키 생성 및 권한 설정
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # 키 파일 확인 (디버깅)
          echo "Checking key file..."
          echo "File size: $(wc -c < ~/.ssh/deploy_key) bytes"
          echo "First line: $(head -1 ~/.ssh/deploy_key)"
          echo "Last line: $(tail -1 ~/.ssh/deploy_key)"
          
          # SSH 키 형식 검증
          echo "Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/deploy_key 2>&1; then
            echo "Error: Invalid SSH private key format"
            echo "Key file content (first 5 lines):"
            head -5 ~/.ssh/deploy_key
            exit 1
          fi
          
          # Known hosts 설정
          echo "Setting up known hosts..."
          ssh-keyscan -H ${{ secrets.PUBLIC_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ secrets.PRIVATE_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Public EC2 연결 테스트
          echo "Testing connection to Public EC2..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} "echo 'Connection successful'" || {
            echo "Error: Failed to connect to Public EC2"
            echo "Trying verbose mode for debugging..."
            ssh -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              ubuntu@${{ secrets.PUBLIC_EC2_IP }} "echo 'test'" 2>&1 | tail -20
            exit 1
          }
      
      # SSH 키를 Public EC2에 복사 (Private EC2 접근용)
      - name: Copy SSH key to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ~/.ssh/deploy_key \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/.ssh/deploy_key
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} "chmod 600 ~/.ssh/deploy_key && mkdir -p ~/.ssh && chmod 700 ~/.ssh"
      
      - name: Create frontend archive
        run: |
          tar -czf frontend.tar.gz \
            Dockerfile \
            package*.json \
            public/ \
            server.js \
            .dockerignore \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='*.log'
      
      - name: Transfer frontend archive to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            frontend.tar.gz \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/
      
      - name: Create remote directory
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }} \
            "mkdir -p ${{ env.PROJECT_DIR }}/3-caleb-son-community-FE"
          ENDSSH
      
      - name: Transfer frontend files to Private EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            frontend.tar.gz \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }}:${{ env.PROJECT_DIR }}/3-caleb-son-community-FE/
          rm frontend.tar.gz
          ENDSSH
      
      - name: Extract frontend files
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }} << ENDSSH2
          cd ${{ env.PROJECT_DIR }}/3-caleb-son-community-FE
          tar -xzf frontend.tar.gz
          rm frontend.tar.gz
          ENDSSH2
          ENDSSH
      
      - name: Stop frontend container
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }} << ENDSSH2
          cd ${{ env.PROJECT_DIR }}
          docker-compose stop frontend || true
          docker-compose rm -f frontend || true
          ENDSSH2
          ENDSSH
      
      - name: Rebuild and start frontend
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} << ENDSSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PRIVATE_EC2_IP }} << ENDSSH2
          cd ${{ env.PROJECT_DIR }}
          docker-compose build frontend
          docker-compose up -d frontend
          ENDSSH2
          ENDSSH
      
      - name: Wait for frontend to start
        run: sleep 20
      
      - name: Check frontend status
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} \
            "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.PRIVATE_EC2_IP }} 'cd ${{ env.PROJECT_DIR }} && docker-compose ps frontend'"
      
      - name: Check frontend logs
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.PUBLIC_EC2_IP }} \
            "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.PRIVATE_EC2_IP }} 'cd ${{ env.PROJECT_DIR }} && docker-compose logs --tail=50 frontend'"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f frontend.tar.gz
      
      - name: Deployment Summary
        run: |
          echo "========================================="
          echo "Frontend Deployment Completed!"
          echo "========================================="
          echo "Frontend URL: http://${{ secrets.PUBLIC_EC2_IP }}"
          echo "Nginx: http://${{ secrets.PUBLIC_EC2_IP }}"
