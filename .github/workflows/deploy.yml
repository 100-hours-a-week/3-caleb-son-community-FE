name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_DIR: ~/community-project
  NGINX_DIR: ~/nginx-proxy

jobs:
  deploy-frontend:
    name: Build & Deploy Frontend (with Nginx)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PUBLIC_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          ssh-keyscan -H ${{ secrets.PRIVATE_EC2_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Build Docker Image
        run: |
          # Build explicitly for amd64 (EC2 architecture)
          docker build --platform linux/amd64 -t community-frontend:latest .
          docker save -o frontend-image.tar community-frontend:latest
          
          # Prepare Nginx archive
          tar -czf nginx.tar.gz nginx/
      
      - name: Transfer Files to Public EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no frontend-image.tar ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no nginx.tar.gz ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${{ secrets.PUBLIC_EC2_IP }}:~/
      
      - name: Deploy to Private EC2
        run: |
          # SSH Jump Host Command
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.PUBLIC_EC2_IP }} << 'EOF'
            set -e
            
            # --- 1. Deploy Nginx (Frontend Reverse Proxy) on Public EC2 or Prepare for Private? ---
            # NOTE: Nginx is running on Public EC2 as per existing setup
            
            # Deploy Nginx Config
            mkdir -p ${{ env.NGINX_DIR }}
            mv ~/nginx.tar.gz ${{ env.NGINX_DIR }}/
            cd ${{ env.NGINX_DIR }}
            tar -xzf nginx.tar.gz
            rm nginx.tar.gz
            
            # Configure Upstream IPs
            echo "Configuring Nginx upstream IPs..."
            sed -i "s/server [0-9.]*:8080/server ${{ secrets.PRIVATE_EC2_IP }}:8080/g" nginx/nginx.conf
            sed -i "s/server [0-9.]*:3003/server ${{ secrets.PRIVATE_EC2_IP }}:3003/g" nginx/nginx.conf
            
            # Restart Nginx
            cd nginx
            docker-compose down || true
            docker-compose up -d
            echo "Nginx deployed successfully."


            # --- 2. Deploy Frontend App on Private EC2 ---
            
            # Ensure directory exists on Private EC2
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.PRIVATE_EC2_IP }} \
              "mkdir -p ${{ env.PROJECT_DIR }}/3-caleb-son-community-FE"
            
            # Transfer Files to Private EC2
            echo "Transferring files to Private EC2..."
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ~/frontend-image.tar \
              ubuntu@${{ secrets.PRIVATE_EC2_IP }}:${{ env.PROJECT_DIR }}/3-caleb-son-community-FE/
              
            # Also transfer docker-compose.yml 
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ~/docker-compose.yml \
              ubuntu@${{ secrets.PRIVATE_EC2_IP }}:${{ env.PROJECT_DIR }}/
              
            rm ~/docker-compose.yml # Cleanup on Public EC2
            
            # Deploy on Private EC2
            echo "Deploying on Private EC2..."
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.PRIVATE_EC2_IP }} << 'INNER_EOF'
              set -e
              cd ${{ env.PROJECT_DIR }}/3-caleb-son-community-FE
              
              # Load & Tag Image
              docker load -i frontend-image.tar
              docker tag community-frontend:latest community-project-frontend:latest
              rm frontend-image.tar
              
              # Restart Service
              cd ${{ env.PROJECT_DIR }}
              docker-compose stop frontend || true
              docker-compose rm -f frontend || true
              docker-compose up -d frontend
            INNER_EOF
            
            # Cleanup on Public EC2
            rm ~/frontend-image.tar
            echo "Frontend Deployment Complete!"
          EOF
