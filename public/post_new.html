<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ê²Œì‹œê¸€ ì‘ì„±</title>
  <link rel="stylesheet" href="/css/style.css"/>
  <!-- Highlight.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
  <div class="wrap">
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button class="back-button" onclick="history.back()">â†</button>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="post-new-container">
      <h2 class="page-title">ê²Œì‹œê¸€ ì‘ì„±</h2>
      
      <div class="post-form-card">
        <!-- ì œëª© ì…ë ¥ -->
        <div class="form-group">
          <label class="form-label required">ì œëª©</label>
          <input 
            type="text" 
            id="title" 
            class="form-input" 
            placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 26ê¸€ì)"
            maxlength="26"
          />
        </div>
        
        <!-- ë‚´ìš© ì…ë ¥ -->
        <div class="form-group">
          <div class="form-label-row">
            <label class="form-label required">ë‚´ìš©</label>
            <button type="button" class="help-btn" id="markdownHelpBtn" title="ë§ˆí¬ë‹¤ìš´ ì‚¬ìš©ë²•">
              <span>?</span>
            </button>
          </div>
          <textarea 
            id="content" 
            class="form-textarea" 
            placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.&#10;&#10;ì½”ë“œ ë¸”ë¡ ì˜ˆì‹œ:&#10;```javascript&#10;const example = 'code';&#10;```"
            rows="8"
          ></textarea>
          <div class="markdown-hint" id="markdownHint">
            <div class="markdown-hint-header" onclick="toggleMarkdownHint()">
              <div class="markdown-hint-title">ğŸ’¡ ë§ˆí¬ë‹¤ìš´ ì‚¬ìš©ë²•</div>
              <span class="markdown-hint-toggle">â–¼</span>
            </div>
            <div class="markdown-hint-content" id="markdownHintContent" style="display: none;">
              <div class="markdown-example">
                <strong>ì½”ë“œ ë¸”ë¡:</strong>
                <pre><code>```javascript
const example = "ì½”ë“œ ì˜ˆì‹œ";
console.log(example);
```</code></pre>
              </div>
              <div class="markdown-example">
                <strong>ì¸ë¼ì¸ ì½”ë“œ:</strong>
                <code>`const x = 1;`</code>
              </div>
              <div class="markdown-example">
                <strong>ì§€ì› ì–¸ì–´:</strong> javascript, python, java, html, css, json ë“±
              </div>
            </div>
          </div>
        </div>
        
        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
        <div class="form-group">
          <label class="form-label">ì´ë¯¸ì§€</label>
          <div class="image-upload-area">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
            <button type="button" id="selectFileBtn" class="file-select-btn">íŒŒì¼ ì„ íƒ</button>
            <span class="file-instruction">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
          </div>
          <div id="imagePreview" class="image-preview"></div>
        </div>
        
        <!-- ì™„ë£Œ ë²„íŠ¼ -->
        <button id="btnSave" class="submit-btn disabled">ì™„ë£Œ</button>
      </div>
    </div>
  </div>

  <!-- ë§ˆí¬ë‹¤ìš´ ê°€ì´ë“œ ëª¨ë‹¬ -->
  <div id="markdownGuideModal" class="modal">
    <div class="modal-content" style="max-width: 600px; text-align: left;">
      <h3>ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© ê°€ì´ë“œ</h3>
      <div class="markdown-guide-content">
        <div class="guide-section">
          <h4>ğŸ“ ì½”ë“œ ë¸”ë¡</h4>
          <p>ì½”ë“œ ë¸”ë¡ì€ ì„¸ ê°œì˜ ë°±í‹±(`)ìœ¼ë¡œ ê°ì‹¸ì„œ ì‘ì„±í•©ë‹ˆë‹¤:</p>
          <pre><code>```javascript
function hello() {
  console.log("Hello, World!");
}
```</code></pre>
        </div>
        
        <div class="guide-section">
          <h4>ğŸ’» ì¸ë¼ì¸ ì½”ë“œ</h4>
          <p>í•œ ì¤„ ì½”ë“œëŠ” ë°±í‹± í•˜ë‚˜ë¡œ ê°ì‹¸ë©´ ë©ë‹ˆë‹¤:</p>
          <p>ì˜ˆ: <code>`const x = 1;`</code></p>
        </div>
        
        <div class="guide-section">
          <h4>ğŸŒ ì§€ì›í•˜ëŠ” ì–¸ì–´</h4>
          <p>javascript, python, java, html, css, json, typescript, go, rust, cpp ë“± ëŒ€ë¶€ë¶„ì˜ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="guide-section">
          <h4>âœ¨ ê¸°íƒ€ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•</h4>
          <ul>
            <li><strong>êµµê²Œ:</strong> <code>**í…ìŠ¤íŠ¸**</code></li>
            <li><em>ê¸°ìš¸ì„:</em> <code>*í…ìŠ¤íŠ¸*</code></li>
            <li>ì¤„ë°”ê¿ˆ: ë‘ ë²ˆì˜ ê³µë°± ë˜ëŠ” ë¹ˆ ì¤„</li>
          </ul>
        </div>
      </div>
      <div class="modal-actions">
        <button id="btnCloseMarkdownGuide" class="btn-confirm">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/aside.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/lambda-upload.js"></script>
  <!-- Marked.js for markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <!-- Highlight.js for syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    renderHeader();
    if(!requireLogin('/login')){}
    
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
    const currentUser = Auth.profile();
    if(currentUser?.imageUrl) {
      document.querySelector('.profile_circle').src = currentUser.imageUrl;
    }
    
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const submitBtn = document.getElementById('btnSave');
    const imageInput = document.getElementById('imageInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const imagePreview = document.getElementById('imagePreview');
    
    let selectedImages = [];
    const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
    const MAX_TOTAL_SIZE = 5 * 1024 * 1024; // 5MB
    const TARGET_SIZE = 1 * 1024 * 1024; // 1MB
    const MAX_IMAGE_COUNT = 10; // ìµœëŒ€ ì´ë¯¸ì§€ ê°œìˆ˜
    
    const params = new URLSearchParams(location.search);
    const postId = params.get('id');

    let images = []; // Array to hold both existing and new images: {url or file, isNew}

    if (postId) {
      document.querySelector('.page-title').textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
      loadPostData(postId);
    }

    async function loadPostData(id) {
      try {
        const res = await apiFetch(`/posts/${id}?increaseView=false`);
        const p = res.data;

        titleInput.value = p.title;
        contentInput.value = p.content;

        // Load existing images
        images = p.images ? p.images.map(img => ({ url: img.imageUrl, isNew: false })) : [];

        displayImagePreview(images);
        updateSubmitButton();
        checkForChanges();
      } catch (e) {
        alert('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
      }
    }

    // Toast ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast-message';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì§§ì€ ë”œë ˆì´
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // ì§€ì •ëœ ì‹œê°„ í›„ ì œê±°
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, duration);
    }
    
    // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­
    selectFileBtn.addEventListener('click', () => {
      imageInput.click();
    });
    
    // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
    async function compressImage(file, targetSize) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // ìµœëŒ€ í¬ê¸° ì œí•œ (ê¸´ ìª½ì„ 1920pxë¡œ)
            const maxDimension = 1920;
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height / width) * maxDimension;
                width = maxDimension;
              } else {
                width = (width / height) * maxDimension;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // í’ˆì§ˆì„ ì¡°ì ˆí•˜ë©° ì••ì¶•
            let quality = 0.9;
            const tryCompress = () => {
              canvas.toBlob((blob) => {
                if (blob.size <= targetSize || quality <= 0.1) {
                  // ëª©í‘œ í¬ê¸° ë‹¬ì„± ë˜ëŠ” ìµœì†Œ í’ˆì§ˆ
                  resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                } else {
                  // í’ˆì§ˆì„ ë‚®ì¶°ì„œ ì¬ì‹œë„
                  quality -= 0.1;
                  tryCompress();
                }
              }, 'image/jpeg', quality);
            };
            
            tryCompress();
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
    imageInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í•„í„°ë§
      const imageFiles = files.filter(file => {
        return file.type.startsWith('image/');
      });
      
      if (imageFiles.length !== files.length) {
        showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }
      
      if (imageFiles.length === 0) return;
      
      // ìµœëŒ€ ì´ë¯¸ì§€ ê°œìˆ˜ ì²´í¬
      if (imageFiles.length + images.length > MAX_IMAGE_COUNT) {
        showToast(`ìµœëŒ€ ${MAX_IMAGE_COUNT}ê°œì˜ ì´ë¯¸ì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        imageInput.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      imagePreview.innerHTML = '<div style="text-align: center; padding: 20px;">ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...</div>';
      
      try {
        // ì´ë¯¸ì§€ ì••ì¶• ì²˜ë¦¬
        const processedImages = [];
        for (const file of imageFiles) {
          if (file.size > MAX_FILE_SIZE) {
            // 2MB ì´ˆê³¼ ì‹œ ì••ì¶•
            console.log(`ì••ì¶• ì „: ${file.name} - ${(file.size / 1024 / 1024).toFixed(2)}MB`);
            const compressed = await compressImage(file, TARGET_SIZE);
            console.log(`ì••ì¶• í›„: ${compressed.name} - ${(compressed.size / 1024 / 1024).toFixed(2)}MB`);
            processedImages.push(compressed);
          } else {
            processedImages.push(file);
          }
        }
        
        // ì´ ìš©ëŸ‰ ì²´í¬
        const totalSize = processedImages.reduce((sum, file) => sum + file.size, 0) +
                          images.reduce((sum, img) => sum + (img.isNew ? img.file.size : 0), 0);
        if (totalSize > MAX_TOTAL_SIZE) {
          showToast(`ì´ë¯¸ì§€ ì´ ìš©ëŸ‰ì´ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í˜„ì¬: ${(totalSize / 1024 / 1024).toFixed(2)}MB)`);
          imagePreview.innerHTML = '';
          imageInput.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
          return;
        }
        
        // Add new images to the array
        processedImages.forEach(file => {
          images.push({ file, isNew: true });
        });

        displayImagePreview(images);
        checkForChanges(); // ì´ë¯¸ì§€ ì„ íƒ ì‹œì—ë„ ë³€ê²½ ì‚¬í•­ ì²´í¬
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        showToast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        imagePreview.innerHTML = '';
        imageInput.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
      }
    });
    
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    function displayImagePreview(imgList) {
      imagePreview.innerHTML = '';
      imgList.forEach((img, index) => {
        const container = document.createElement('div');
        container.className = 'preview-container';

        const imgEl = document.createElement('img');
        imgEl.src = img.isNew ? URL.createObjectURL(img.file) : img.url;
        imgEl.className = 'preview-image';
        imgEl.alt = `ë¯¸ë¦¬ë³´ê¸° ${index + 1}`;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-image-btn';
        deleteBtn.textContent = 'x';
        deleteBtn.onclick = () => {
          images.splice(index, 1);
          displayImagePreview(images);
          checkForChanges();
        };

        container.appendChild(imgEl);
        container.appendChild(deleteBtn);
        imagePreview.appendChild(container);
      });
    }
    
    // í¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateSubmitButton() {
      const hasTitle = titleInput.value.trim().length > 0;
      const hasContent = contentInput.value.trim().length > 0;
      const isValid = hasTitle && hasContent;
      
      if (isValid) {
        submitBtn.classList.remove('disabled');
        submitBtn.classList.add('enabled');
      } else {
        submitBtn.classList.remove('enabled');
        submitBtn.classList.add('disabled');
      }
    }
    
    // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    titleInput.addEventListener('input', updateSubmitButton);
    contentInput.addEventListener('input', updateSubmitButton);
    
    // í˜ì´ì§€ ì´íƒˆ ë°©ì§€ ê¸°ëŠ¥
    let hasUnsavedChanges = false;
    let isSubmitting = false;
    
    // ì…ë ¥ ë‚´ìš© ë³€ê²½ ê°ì§€
    function checkForChanges() {
      const hasTitle = titleInput.value.trim().length > 0;
      const hasContent = contentInput.value.trim().length > 0;
      const hasImages = images.length > 0;
      
      hasUnsavedChanges = hasTitle || hasContent || hasImages;
    }
    
    // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
    titleInput.addEventListener('input', checkForChanges);
    contentInput.addEventListener('input', checkForChanges);
    
    // ì´ë¯¸ì§€ ë³€ê²½ ì‹œì—ë„ ì²´í¬ (ê¸°ì¡´ ì´ë¯¸ì§€ ì„ íƒ ë¡œì§ì— ì¶”ê°€ë¨)
    
    // beforeunload ì´ë²¤íŠ¸ë¡œ í˜ì´ì§€ ì´íƒˆ ë°©ì§€
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges && !isSubmitting) {
        e.preventDefault();
        e.returnValue = 'ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ë©´ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
        return e.returnValue;
      }
    });
    
    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í´ë¦­ ì‹œì—ë„ í™•ì¸
    document.querySelector('.back-button').addEventListener('click', (e) => {
      if (hasUnsavedChanges && !isSubmitting) {
        const confirmLeave = confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ë©´ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!confirmLeave) {
          e.preventDefault();
          return false;
        }
      }
    });
    
    // ë§ˆí¬ë‹¤ìš´ ê°€ì´ë“œ ëª¨ë‹¬
    const markdownHelpBtn = document.getElementById('markdownHelpBtn');
    const markdownGuideModal = document.getElementById('markdownGuideModal');
    const btnCloseMarkdownGuide = document.getElementById('btnCloseMarkdownGuide');
    
    if (markdownHelpBtn && markdownGuideModal && btnCloseMarkdownGuide) {
      markdownHelpBtn.addEventListener('click', () => {
        markdownGuideModal.style.display = 'flex';
      });
      
      btnCloseMarkdownGuide.addEventListener('click', () => {
        markdownGuideModal.style.display = 'none';
      });
      
      markdownGuideModal.addEventListener('click', (e) => {
        if (e.target.id === 'markdownGuideModal') {
          markdownGuideModal.style.display = 'none';
        }
      });
    }
    
    // ë§ˆí¬ë‹¤ìš´ íŒíŠ¸ ì ‘ê¸°/í¼ì¹˜ê¸°
    window.toggleMarkdownHint = function() {
      const content = document.getElementById('markdownHintContent');
      const toggle = document.querySelector('.markdown-hint-toggle');
      if (content && toggle) {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          toggle.textContent = 'â–²';
        } else {
          content.style.display = 'none';
          toggle.textContent = 'â–¼';
        }
      }
    };
    
    // ì œì¶œ ë²„íŠ¼ í´ë¦­
    submitBtn.addEventListener('click', async () => {
      // disabled ìƒíƒœì¼ ë•ŒëŠ” í´ë¦­ ë¬´ì‹œ
      if (submitBtn.classList.contains('disabled')) {
        return;
      }
      
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !content) {
        alert('*ì œëª©, ë‚´ìš©ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”');
        return;
      }
      
      // ì œì¶œ ì‹œì‘ - ì´íƒˆ ë°©ì§€ í•´ì œ
      isSubmitting = true;
      
      // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
      submitBtn.disabled = true;
      submitBtn.classList.add('disabled');
      submitBtn.classList.remove('enabled');
      submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
      
      try {
        let imageUrlsString = '';

        if (postId) {
          // For edit mode
          const newImageUrls = [];
        
          // Upload new images
          for (const img of images.filter(i => i.isNew)) {
            // Lambdaë¥¼ í†µí•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
            const imageUrl = await uploadImageFlexible(img.file, 'images', LAMBDA_CONFIG.enabled);
            newImageUrls.push(imageUrl);
          }

          // Combine existing and new URLs
          const existingUrls = images.filter(i => !i.isNew).map(i => i.url);
          const allUrls = existingUrls.concat(newImageUrls);
          imageUrlsString = allUrls.join(',');

          // Update post
          const response = await apiFetch(`/posts/${postId}`, {
            method: 'PATCH',
            body: JSON.stringify({
              title: title,
              content: content,
              imageUrls: imageUrlsString
            })
          });

          if (response) {
            location.href = `/post_detail.html?id=${postId}`;
          }
        } else {
          // Original create mode
          const imageUrls = [];

          if (images.length > 0) {
            for (const img of images.filter(i => i.isNew)) {  // Only upload new images, but in create all are new
              // Lambdaë¥¼ í†µí•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
              const imageUrl = await uploadImageFlexible(img.file, 'images', LAMBDA_CONFIG.enabled);
              imageUrls.push(imageUrl);
            }
          }
        
          imageUrlsString = imageUrls.join(',');
        
        const response = await apiFetch('/posts', {
          method: 'POST',
          body: JSON.stringify({
            title: title,
            content: content,
            imageUrls: imageUrlsString
          })
        });
        
          const newPostId = response?.data?.postId;
        
          if (newPostId) {
            location.href = `/post_detail.html?id=${newPostId}`;
        } else {
          location.href = '/';
          }
        }
      } catch (e) {
        alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + (e.message || 'unknown'));
        // ì œì¶œ ì‹¤íŒ¨ ì‹œ ì´íƒˆ ë°©ì§€ ë‹¤ì‹œ í™œì„±í™”
        isSubmitting = false;
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        submitBtn.disabled = false;
        submitBtn.textContent = 'ì™„ë£Œ';
      }
    });
  </script>
</body>
</html>
