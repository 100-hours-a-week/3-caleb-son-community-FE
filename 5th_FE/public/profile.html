<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>회원정보 수정</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
  <div class="wrap">
    <!-- 뒤로가기 버튼 -->
    <button class="back-button" onclick="history.back()">←</button>
    
    <!-- 메인 컨텐츠 -->
    <div class="contents">
      <div class="profile-edit-container">
        <h1 class="profile-edit-title">회원정보 수정</h1>
        
        <div class="profile-image-section">
          <img id="profileImage" src="/assets/images/account_circle.png" alt="프로필 이미지" class="profile-large" onclick="document.getElementById('imageInput').click()"/>
          <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)"/>
        </div>
        
        <div class="profile-form-card">
          <div class="form-group">
            <label class="form-label">이메일</label>
            <div class="email-display" id="emailDisplay">caleb123@gmail.com</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">닉네임</label>
            <input type="text" id="nicknameInput" class="form-input" placeholder="현재 닉네임" maxlength="10"/>
            <div class="helper-text hidden" id="nicknameHelper"></div>
          </div>
          
          <button id="btnUpdate" class="update-button">수정하기</button>
          <button id="btnWithdraw" class="withdraw-button">회원 탈퇴하기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 회원 탈퇴 확인 모달 -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <h3>회원 탈퇴</h3>
      <p>정말로 회원 탈퇴를 하시겠습니까?</p>
      <p class="warning-text">탈퇴 시 모든 데이터가 삭제되며 복구할 수 없습니다.</p>
      <div class="modal-actions">
        <button id="btnConfirmWithdraw" class="btn-confirm">탈퇴하기</button>
        <button id="btnCancelWithdraw" class="btn-cancel">취소</button>
      </div>
    </div>
  </div>
  
  <script src="/js/auth.js"></script>
  <script src="/js/aside.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/lambda-upload.js"></script>
  <script>
    renderHeader();
    if(!requireLogin('/login')){}
    
    // 현재 사용자 정보 로드
    const currentUser = Auth.profile();
    const userId = Auth.userId();
    
    // 이메일 표시
    document.getElementById('emailDisplay').textContent = currentUser?.email || 'caleb123@gmail.com';
    
    // 닉네임 입력 필드에 현재 닉네임 설정
    document.getElementById('nicknameInput').value = currentUser?.nickname || '';
    document.getElementById('nicknameInput').placeholder = currentUser?.nickname || '현재 닉네임';
    
    const nicknameInput = document.getElementById('nicknameInput');
    const btnUpdate = document.getElementById('btnUpdate');

    // Toast 메시지 표시 함수
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast-message';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // 애니메이션을 위한 짧은 딜레이
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 지정된 시간 후 제거
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, duration);
    }

    // 닉네임 유효성 검사 함수
    function validateNickname(nickname) {
      // 길이 체크 (2-10자)
      if (nickname.length < 2 || nickname.length > 10) {
        return { isValid: false, error: '닉네임은 2-10자 이내여야 합니다.' };
      }
      
      // 공백 체크
      if (nickname.includes(' ')) {
        return { isValid: false, error: '닉네임에 공백을 포함할 수 없습니다.' };
      }
      
      // 허용된 문자만 사용 (한글, 영어, 숫자, 언더바)
      const allowedPattern = /^[가-힣a-zA-Z0-9_]+$/;
      if (!allowedPattern.test(nickname)) {
        return { isValid: false, error: '한글, 영어, 숫자, 언더바(_)만 사용 가능합니다.' };
      }
      
      // 숫자만으로 구성되면 안됨
      const onlyNumberPattern = /^[0-9]+$/;
      if (onlyNumberPattern.test(nickname)) {
        return { isValid: false, error: '숫자만으로 닉네임을 구성할 수 없습니다.' };
      }
      
      return { isValid: true, error: null };
    }

    // Helper 텍스트 업데이트 함수들
    function showHelperText(elementId, message, isError = false) {
      const helper = document.getElementById(elementId);
      helper.textContent = message;
      helper.className = isError ? 'helper-text error show' : 'helper-text success show';
    }
    
    function hideHelperText(elementId) {
      const helper = document.getElementById(elementId);
      helper.className = 'helper-text hidden';
    }

    function updateButtonState() {
      const nickname = nicknameInput.value.trim();
      const validation = validateNickname(nickname);
      btnUpdate.disabled = !nickname || !validation.isValid;
    }

    nicknameInput.addEventListener('input', updateButtonState);
    
    // 닉네임 실시간 유효성 검사
    nicknameInput.addEventListener('blur', (e) => {
      const nickname = e.target.value.trim();
      if (nickname === '') {
        hideHelperText('nicknameHelper');
      } else {
        const validation = validateNickname(nickname);
        if (validation.isValid) {
          showHelperText('nicknameHelper', '✓ 사용 가능한 닉네임입니다', false);
        } else {
          showHelperText('nicknameHelper', validation.error, true);
        }
      }
      updateButtonState();
    });
    
    nicknameInput.addEventListener('focus', (e) => {
      const nickname = e.target.value.trim();
      if (nickname !== '') {
        const validation = validateNickname(nickname);
        if (!validation.isValid) {
          showHelperText('nicknameHelper', validation.error, true);
        }
      }
    });
    
    updateButtonState();
    
    // 프로필 이미지 설정
    if(currentUser?.imageUrl) {
      document.getElementById('profileImage').src = currentUser.imageUrl;
      document.querySelector('.profile_circle').src = currentUser.imageUrl;
    }
    
    // 이미지 업로드 처리 함수
    window.handleImageUpload = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      // 파일 크기 검사 (5MB 제한)
      if (file.size > 5 * 1024 * 1024) {
        alert('파일 크기는 5MB 이하여야 합니다.');
        return;
      }
      
      // 이미지 파일 타입 검사
      if (!file.type.startsWith('image/')) {
        alert('이미지 파일만 업로드 가능합니다.');
        return;
      }
      
      try {
        // Lambda를 통한 프로필 이미지 업로드
        const imageUrl = await uploadImageFlexible(file, 'profiles', LAMBDA_CONFIG.enabled);
        
        if (imageUrl) {
          // 업로드 성공 시 이미지 URL 업데이트
          document.getElementById('profileImage').src = imageUrl;
          document.querySelector('.profile_circle').src = imageUrl;
          
          // 로컬 저장소에 이미지 URL 저장
          Auth.setProfile({ 
            ...currentUser, 
            imageUrl: imageUrl 
          });
          
          // 백엔드에도 프로필 이미지 업데이트
          try {
            await apiFetch('/users/profile', {
              method: 'PUT',
              body: JSON.stringify({ 
                nickname: currentUser?.nickname || '',
                profile_image_url: imageUrl
              })
            });
          } catch (updateError) {
            console.warn('백엔드 프로필 업데이트 실패:', updateError);
            // 업로드는 성공했으므로 계속 진행
          }
          
          alert('프로필 이미지가 업데이트되었습니다.');
        }
      } catch (error) {
        console.error('이미지 업로드 실패:', error);
        alert('이미지 업로드에 실패했습니다. 다시 시도해주세요.');
      }
    };
    
    // 수정하기 버튼 클릭 이벤트
    document.getElementById('btnUpdate').addEventListener('click', async () => {
      const nickname = document.getElementById('nicknameInput').value.trim();
      
      if(!nickname) {
        showToast('닉네임을 입력해주세요.');
        return;
      }
      
      // 닉네임 유효성 검사
      const validation = validateNickname(nickname);
      if (!validation.isValid) {
        showHelperText('nicknameHelper', validation.error, true);
        showToast(validation.error);
        return;
      }
      
      try {
        // 백엔드 API 호출로 사용자 정보 업데이트
        const response = await apiFetch('/users/profile', {
          method: 'PUT',
          body: JSON.stringify({ 
            nickname: nickname,
            profile_image_url: currentUser?.imageUrl || null
          })
        });
        
        // 로컬 저장소 업데이트
        Auth.setProfile({ 
          ...currentUser, 
          nickname: nickname 
        });
        
        showToast('회원정보가 수정되었습니다.');
        setTimeout(() => location.reload(), 1000);
      } catch (error) {
        console.error('회원정보 수정 실패:', error);
        showToast('회원정보 수정에 실패했습니다. 다시 시도해주세요.');
      }
    });

    // 회원 탈퇴 버튼 클릭 이벤트
    document.getElementById('btnWithdraw').addEventListener('click', () => {
      document.getElementById('withdrawModal').style.display = 'flex';
    });

    // 회원 탈퇴 확인 버튼 클릭 이벤트
    document.getElementById('btnConfirmWithdraw').addEventListener('click', async () => {
      try {
        // 백엔드 API 호출로 회원 탈퇴
        await apiFetch('/users/withdraw', {
          method: 'DELETE'
        });

        alert('회원 탈퇴가 완료되었습니다.');
        
        // 로그아웃 처리
        Auth.logout();
        
        // 메인 페이지로 이동
        location.href = '/';
      } catch (error) {
        console.error('회원 탈퇴 실패:', error);
        alert('회원 탈퇴에 실패했습니다. 다시 시도해주세요.');
      }
    });

    // 회원 탈퇴 취소 버튼 클릭 이벤트
    document.getElementById('btnCancelWithdraw').addEventListener('click', () => {
      document.getElementById('withdrawModal').style.display = 'none';
    });

    // 모달 배경 클릭으로 닫기
    document.getElementById('withdrawModal').addEventListener('click', (e) => {
      if (e.target.id === 'withdrawModal') {
        document.getElementById('withdrawModal').style.display = 'none';
      }
    });
  </script>
</body>
</html>
