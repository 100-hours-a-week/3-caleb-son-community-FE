<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>게시글 작성</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
  <div class="wrap">
    <!-- 뒤로가기 버튼 -->
    <button class="back-button" onclick="history.back()">←</button>
    
    <!-- 메인 컨텐츠 -->
    <div class="post-new-container">
      <h2 class="page-title">게시글 작성</h2>
      
      <div class="post-form-card">
        <!-- 제목 입력 -->
        <div class="form-group">
          <label class="form-label required">제목</label>
          <input 
            type="text" 
            id="title" 
            class="form-input" 
            placeholder="제목을 입력해주세요. (최대 26글자)"
            maxlength="26"
          />
        </div>
        
        <!-- 내용 입력 -->
        <div class="form-group">
          <label class="form-label required">내용</label>
          <textarea 
            id="content" 
            class="form-textarea" 
            placeholder="내용을 입력해주세요."
            rows="8"
          ></textarea>
        </div>
        
        <!-- 이미지 업로드 -->
        <div class="form-group">
          <label class="form-label">이미지</label>
          <div class="image-upload-area">
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
            <button type="button" id="selectFileBtn" class="file-select-btn">파일 선택</button>
            <span class="file-instruction">파일을 선택해주세요.</span>
          </div>
          <div id="imagePreview" class="image-preview"></div>
        </div>
        
        <!-- 완료 버튼 -->
        <button id="btnSave" class="submit-btn disabled">완료</button>
      </div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/aside.js"></script>
  <script src="/js/ui.js"></script>
  <script>
    renderHeader();
    if(!requireLogin('/login')){}
    
    // 프로필 이미지 설정
    const currentUser = Auth.profile();
    if(currentUser?.imageUrl) {
      document.querySelector('.profile_circle').src = currentUser.imageUrl;
    }
    
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const submitBtn = document.getElementById('btnSave');
    const imageInput = document.getElementById('imageInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const imagePreview = document.getElementById('imagePreview');
    
    let selectedImages = [];
    const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
    const MAX_TOTAL_SIZE = 5 * 1024 * 1024; // 5MB
    const TARGET_SIZE = 1 * 1024 * 1024; // 1MB
    const MAX_IMAGE_COUNT = 10; // 최대 이미지 개수
    
    const params = new URLSearchParams(location.search);
    const postId = params.get('id');

    let images = []; // Array to hold both existing and new images: {url or file, isNew}

    if (postId) {
      document.querySelector('.page-title').textContent = '게시글 수정';
      loadPostData(postId);
    }

    async function loadPostData(id) {
      try {
        const res = await apiFetch(`/posts/${id}?increaseView=false`);
        const p = res.data;

        titleInput.value = p.title;
        contentInput.value = p.content;

        // Load existing images
        images = p.images ? p.images.map(img => ({ url: img.imageUrl, isNew: false })) : [];

        displayImagePreview(images);
        updateSubmitButton();
        checkForChanges();
      } catch (e) {
        alert('게시글 불러오기에 실패했습니다: ' + e.message);
      }
    }

    // Toast 메시지 표시 함수
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast-message';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // 애니메이션을 위한 짧은 딜레이
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 지정된 시간 후 제거
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, duration);
    }
    
    // 파일 선택 버튼 클릭
    selectFileBtn.addEventListener('click', () => {
      imageInput.click();
    });
    
    // 이미지 압축 함수
    async function compressImage(file, targetSize) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // 최대 크기 제한 (긴 쪽을 1920px로)
            const maxDimension = 1920;
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height / width) * maxDimension;
                width = maxDimension;
              } else {
                width = (width / height) * maxDimension;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // 품질을 조절하며 압축
            let quality = 0.9;
            const tryCompress = () => {
              canvas.toBlob((blob) => {
                if (blob.size <= targetSize || quality <= 0.1) {
                  // 목표 크기 달성 또는 최소 품질
                  resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                } else {
                  // 품질을 낮춰서 재시도
                  quality -= 0.1;
                  tryCompress();
                }
              }, 'image/jpeg', quality);
            };
            
            tryCompress();
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // 이미지 파일 선택
    imageInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      // 이미지 파일만 필터링
      const imageFiles = files.filter(file => {
        return file.type.startsWith('image/');
      });
      
      if (imageFiles.length !== files.length) {
        showToast('이미지 파일만 업로드 가능합니다.');
      }
      
      if (imageFiles.length === 0) return;
      
      // 최대 이미지 개수 체크
      if (imageFiles.length + images.length > MAX_IMAGE_COUNT) {
        showToast(`최대 ${MAX_IMAGE_COUNT}개의 이미지만 첨부할 수 있습니다.`);
        imageInput.value = ''; // 파일 선택 초기화
        return;
      }
      
      // 로딩 표시
      imagePreview.innerHTML = '<div style="text-align: center; padding: 20px;">이미지 처리 중...</div>';
      
      try {
        // 이미지 압축 처리
        const processedImages = [];
        for (const file of imageFiles) {
          if (file.size > MAX_FILE_SIZE) {
            // 2MB 초과 시 압축
            console.log(`압축 전: ${file.name} - ${(file.size / 1024 / 1024).toFixed(2)}MB`);
            const compressed = await compressImage(file, TARGET_SIZE);
            console.log(`압축 후: ${compressed.name} - ${(compressed.size / 1024 / 1024).toFixed(2)}MB`);
            processedImages.push(compressed);
          } else {
            processedImages.push(file);
          }
        }
        
        // 총 용량 체크
        const totalSize = processedImages.reduce((sum, file) => sum + file.size, 0) +
                          images.reduce((sum, img) => sum + (img.isNew ? img.file.size : 0), 0);
        if (totalSize > MAX_TOTAL_SIZE) {
          showToast(`이미지 총 용량이 5MB를 초과합니다. (현재: ${(totalSize / 1024 / 1024).toFixed(2)}MB)`);
          imagePreview.innerHTML = '';
          imageInput.value = ''; // 파일 선택 초기화
          return;
        }
        
        // Add new images to the array
        processedImages.forEach(file => {
          images.push({ file, isNew: true });
        });

        displayImagePreview(images);
        checkForChanges(); // 이미지 선택 시에도 변경 사항 체크
      } catch (error) {
        console.error('이미지 처리 오류:', error);
        showToast('이미지 처리 중 오류가 발생했습니다.');
        imagePreview.innerHTML = '';
        imageInput.value = ''; // 파일 선택 초기화
      }
    });
    
    // 이미지 미리보기 표시
    function displayImagePreview(imgList) {
      imagePreview.innerHTML = '';
      imgList.forEach((img, index) => {
        const container = document.createElement('div');
        container.className = 'preview-container';

        const imgEl = document.createElement('img');
        imgEl.src = img.isNew ? URL.createObjectURL(img.file) : img.url;
        imgEl.className = 'preview-image';
        imgEl.alt = `미리보기 ${index + 1}`;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-image-btn';
        deleteBtn.textContent = 'x';
        deleteBtn.onclick = () => {
          images.splice(index, 1);
          displayImagePreview(images);
          checkForChanges();
        };

        container.appendChild(imgEl);
        container.appendChild(deleteBtn);
        imagePreview.appendChild(container);
      });
    }
    
    // 폼 유효성 검사 및 버튼 상태 업데이트
    function updateSubmitButton() {
      const hasTitle = titleInput.value.trim().length > 0;
      const hasContent = contentInput.value.trim().length > 0;
      const isValid = hasTitle && hasContent;
      
      if (isValid) {
        submitBtn.classList.remove('disabled');
        submitBtn.classList.add('enabled');
      } else {
        submitBtn.classList.remove('enabled');
        submitBtn.classList.add('disabled');
      }
    }
    
    // 입력 이벤트 리스너
    titleInput.addEventListener('input', updateSubmitButton);
    contentInput.addEventListener('input', updateSubmitButton);
    
    // 페이지 이탈 방지 기능
    let hasUnsavedChanges = false;
    let isSubmitting = false;
    
    // 입력 내용 변경 감지
    function checkForChanges() {
      const hasTitle = titleInput.value.trim().length > 0;
      const hasContent = contentInput.value.trim().length > 0;
      const hasImages = images.length > 0;
      
      hasUnsavedChanges = hasTitle || hasContent || hasImages;
    }
    
    // 입력 필드 변경 감지
    titleInput.addEventListener('input', checkForChanges);
    contentInput.addEventListener('input', checkForChanges);
    
    // 이미지 변경 시에도 체크 (기존 이미지 선택 로직에 추가됨)
    
    // beforeunload 이벤트로 페이지 이탈 방지
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges && !isSubmitting) {
        e.preventDefault();
        e.returnValue = '작성 중인 내용이 있습니다. 페이지를 벗어나면 내용이 사라집니다. 정말 나가시겠습니까?';
        return e.returnValue;
      }
    });
    
    // 뒤로가기 버튼 클릭 시에도 확인
    document.querySelector('.back-button').addEventListener('click', (e) => {
      if (hasUnsavedChanges && !isSubmitting) {
        const confirmLeave = confirm('작성 중인 내용이 있습니다. 페이지를 벗어나면 내용이 사라집니다. 정말 나가시겠습니까?');
        if (!confirmLeave) {
          e.preventDefault();
          return false;
        }
      }
    });
    
    // 제출 버튼 클릭
    submitBtn.addEventListener('click', async () => {
      // disabled 상태일 때는 클릭 무시
      if (submitBtn.classList.contains('disabled')) {
        return;
      }
      
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !content) {
        alert('*제목, 내용을 모두 작성해주세요');
        return;
      }
      
      // 제출 시작 - 이탈 방지 해제
      isSubmitting = true;
      
      // 버튼 비활성화 및 로딩 상태
      submitBtn.disabled = true;
      submitBtn.classList.add('disabled');
      submitBtn.classList.remove('enabled');
      submitBtn.textContent = '등록 중...';
      
      try {
        let imageUrlsString = '';

        if (postId) {
          // For edit mode
          const newImageUrls = [];

          // Upload new images
          for (const img of images.filter(i => i.isNew)) {
            const formData = new FormData();
            formData.append('file', img.file);

            const uploadResponse = await apiFetch('/posts/upload-image', {
              method: 'POST',
              headers: {
                'X-USER-ID': Auth.userId()
              },
              body: formData
            });

            if (uploadResponse && uploadResponse.data && uploadResponse.data.imageUrl) {
              newImageUrls.push(uploadResponse.data.imageUrl);
            } else {
              throw new Error('이미지 업로드에 실패했습니다.');
            }
          }

          // Combine existing and new URLs
          const existingUrls = images.filter(i => !i.isNew).map(i => i.url);
          const allUrls = existingUrls.concat(newImageUrls);
          imageUrlsString = allUrls.join(',');

          // Update post
          const response = await apiFetch(`/posts/${postId}`, {
            method: 'PATCH',
            body: JSON.stringify({
              title: title,
              content: content,
              imageUrls: imageUrlsString
            })
          });

          if (response) {
            location.href = `/post_detail.html?id=${postId}`;
          }
        } else {
          // Original create mode
          const imageUrls = [];

          if (images.length > 0) {
            for (const img of images.filter(i => i.isNew)) {  // Only upload new images, but in create all are new
              // FormData로 이미지 파일 업로드
              const formData = new FormData();
              formData.append('file', img.file);
              
              const uploadResponse = await apiFetch('/posts/upload-image', {
                method: 'POST',
                headers: {
                  'X-USER-ID': Auth.userId()
                },
                body: formData
              });
              
              if (uploadResponse && uploadResponse.data && uploadResponse.data.imageUrl) {
                imageUrls.push(uploadResponse.data.imageUrl);
              } else {
                throw new Error('이미지 업로드에 실패했습니다.');
              }
            }
          }

          imageUrlsString = imageUrls.join(',');

          const response = await apiFetch('/posts', {
            method: 'POST',
            body: JSON.stringify({
              title: title,
              content: content,
              imageUrls: imageUrlsString
            })
          });

          const newPostId = response?.data?.postId;

          if (newPostId) {
            location.href = `/post_detail.html?id=${newPostId}`;
          } else {
            location.href = '/';
          }
        }
      } catch (e) {
        alert('처리 실패: ' + (e.message || 'unknown'));
        // 제출 실패 시 이탈 방지 다시 활성화
        isSubmitting = false;
      } finally {
        // 버튼 상태 복원
        submitBtn.disabled = false;
        submitBtn.textContent = '완료';
      }
    });
  </script>
</body>
</html>
